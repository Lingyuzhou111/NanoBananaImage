# NanoBananaImage 插件

## 概述
NanoBananaImage 是一个适用于dow859项目的微信机器人生图插件，可以通过OpenRouter等平台的免费API 调用强大的NanoBanana模型实现文生图和图生图。

## 功能特性

### 1. 文生图功能
- 根据文本描述生成图片
- 支持多种图片风格和主题
- 使用命令：`N画图 + 描述`

### 2. 图片编辑功能
- 上传参考图片进行编辑
- 使用命令：`N改图 + 描述`，然后上传图片

### 3. 图片融合功能
- 将两张图片融合成一张新图片
- 使用命令：`N融图 + 描述`，然后依次上传两张图片

## 配置文件 (config.json)

```json
{
    "base_url": "https://openrouter.ai/api/v1/chat/completions",
    "api_key": "your_api_key_here",
    "model": "google/gemini-2.5-flash-image-preview:free",
    "commands": ["N画图"],
    "merge_commands": ["N融图"],
    "reference_edit_commands": ["N改图"]
}
```

### 配置参数说明

| 参数 | 说明 | 默认值 |
|------|------|--------|
| `base_url` | API接口地址 | https://openrouter.ai/api/v1/chat/completions |
| `api_key` | API访问密钥 | 必须配置 |
| `model` | 使用的AI模型 | google/gemini-2.5-flash-image-preview:free |
| `commands` | 文生图命令前缀 | ["N画图"] |
| `merge_commands` | 融图命令前缀 | ["N融图"] |
| `reference_edit_commands` | 参考图编辑命令前缀 | ["N改图"] |

## 使用方法

### 基本命令格式
```
[命令前缀] + [描述内容]
```

### 使用示例

#### 1. 生成图片
```
N画图 用一张信息图表详细解释牛顿的棱镜实验
```
#### 2. 编辑参考图片
```
N改图 将这张图片转换成水彩画风格
```
然后上传需要编辑的图片

#### 3. 融合两张图片
```
N融图 将这两张图片融合成一张科幻风格的合成图
```
然后依次上传两张需要融合的图片

## 技术特性

### API响应处理
- 支持新的API响应格式（`choices[0].message.images`）
- 向后兼容旧的markdown格式图片URL
- 自动处理base64编码的图片数据
- 智能提取文本和图片内容
- **新增：异步图片生成检测和等待机制**
- **新增：智能base64日志截断，避免刷屏**

### 图片处理
- 支持多种图片格式：JPEG、PNG、WebP
- 自动图片压缩和大小限制
- 图片缓存机制，提高响应速度
- 超时处理和错误重试

### 安全性
- API密钥安全存储
- 图片大小和格式验证
- 请求频率限制
- 错误日志记录

## 错误处理

插件包含完善的错误处理机制：
- API调用失败自动重试
- 图片格式和大小验证
- 超时处理
- 详细的错误日志记录
- **新增：异步图片生成状态检测**

## 日志记录

插件会记录详细的操作日志，包括：
- API请求和响应信息
- 图片处理状态
- 错误信息和异常堆栈
- 性能统计信息
- **新增：图片生成等待状态提示**
- **新增：智能base64数据截断，避免日志文件过大**

## 注意事项

1. **API密钥安全**：请妥善保管您的API密钥，不要泄露给他人
2. **图片大小限制**：单张图片最大支持10MB，超过会自动压缩
3. **图片格式**：支持JPEG、PNG、WebP格式
4. **超时设置**：图片生成可能需要较长时间，请耐心等待
5. **网络要求**：需要稳定的网络连接来调用API服务
6. **异步图片生成**：某些API可能需要等待图片生成完成，插件会自动检测并提示

## 更新日志

### v1.2 (最新)
- **优化日志记录**：避免base64字符串刷屏，使用截断和安全序列化
- **改进调试体验**：base64数据只显示预览，完整数据不输出到日志
- **增强性能**：减少日志文件大小，提高日志可读性

### v1.1
- **修复异步图片生成问题**：检测图片生成提示，避免过早返回文本
- **增强图片提取逻辑**：支持从content中提取base64图片数据
- **改进错误处理**：增加图片生成等待状态检测
- **优化用户体验**：当检测到图片生成中时，提示用户等待

### v1.0
- 初始版本发布
- 支持文生图、图片编辑、融图等功能
- 支持新的API响应格式
- 完善的错误处理和日志记录

## 常见问题解决

### 问题：图片还没生成成功就提前返回了文本消息

**原因分析**：
1. API返回的是图片生成的**描述文本**，而不是实际的图片数据
2. 某些API的图片生成是**异步的**，需要等待完成
3. 插件没有正确识别图片生成状态

**解决方案**：
1. **检查API配置**：确认使用的API端点支持同步图片生成
2. **等待图片生成**：如果API支持异步生成，等待一段时间后重试
3. **查看日志**：检查插件日志中的图片生成状态提示
4. **联系API提供商**：确认图片生成的具体流程和要求

### 问题：API返回了图片ID但没有图片数据

**解决方案**：
1. 使用图片ID调用专门的图片获取接口
2. 等待异步图片生成完成
3. 检查API文档中的图片获取方法

## 技术支持

如果您在使用过程中遇到问题，请检查：
1. 配置文件是否正确
2. API密钥是否有效
3. 网络连接是否正常
4. 查看日志文件获取详细错误信息
5. 确认API是否支持同步图片生成

## 许可证

本插件遵循相关开源许可证，具体请查看项目根目录的LICENSE文件。
